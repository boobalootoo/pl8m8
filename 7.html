<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Balanced Meal Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Define colors for the filled bar segments */
    .protein-fill { background-color: #ef4444; }
    .fat-fill { background-color: #3b82f6; }
    .carb-fill { background-color: #facc15; }
    /* Simple grey background to match the wireframe style */
    .wireframe-panel {
        background-color: #f3f4f6;
        border: 1px solid #d1d5db;
    }
    .draggable-food {
        cursor: grab;
        transition: transform 0.2s ease-in-out;
    }
    .draggable-food:hover {
        transform: scale(1.1);
    }
    .dropzone {
        border: 2px dashed #9ca3af;
        transition: border-color 0.2s ease-in-out;
    }
    .dropzone.drag-over {
        border-color: #4b5563;
    }
    .plate {
        position: absolute;
        width: 6rem;
        height: 6rem;
        cursor: grab;
        transition: all 0.2s ease-in-out;
    }
    .plate:hover {
        transform: scale(1.1);
    }
    
    /* Custom styles for the nutrition buckets */
    .bucket {
      position: relative;
      /* Made the bucket much narrower */
      width: 20px;
      /* Height is now a fixed value based on the new block size */
      border: 2px solid #374151;
      background: #e5e7eb;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      /* Removed margin to eliminate spacing between buckets */
      margin: 0;
      /* Overflow is visible again to allow excess blocks */
      overflow: visible;
    }
    .macro-block {
      /* Made the blocks square */
      width: 10px;
      height: 10px;
      margin: 1px 0;
      border: 1px solid #374151;
    }
    .target-line {
      position: absolute;
      width: 100%;
      border-top: 2px dashed #6b7280;
    }
    .excess-area {
      position: absolute;
      /* Adjusted the bottom position to sit right below the bucket */
      bottom: -1px;
      transform: translateY(100%);
      width: 100%;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      /* Spacing for the excess blocks */
      margin-top: 10px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 font-sans">

  <h1 class="text-3xl font-bold text-gray-800 mb-6">Balanced Meal Builder</h1>

  <div class="flex flex-grow w-full max-w-7xl h-[80vh] gap-4 p-4 rounded-lg shadow-lg bg-white">
    
    <!-- Nutrition Buckets (Left) -->
    <div class="flex flex-col w-1/5 wireframe-panel rounded-lg p-4">
        <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Nutrition Buckets</h2>
        <div class="flex justify-around flex-1 items-stretch">
            <!-- Protein -->
            <div class="flex flex-col items-center relative">
              <!-- Protein bucket sized for 15 blocks (15 * 12px = 180px) -->
              <div class="bucket h-[180px]" id="proteinBucket">
                  <div class="target-line" style="top: 25%;"></div>
              </div>
              <div class="excess-area" id="proteinExcess"></div>
            </div>

            <!-- Fat -->
            <div class="flex flex-col items-center relative">
              <!-- Fat bucket sized for 7 blocks (7 * 12px = 84px) -->
              <div class="bucket h-[84px]" id="fatBucket">
                  <div class="target-line" style="top: 65%;"></div>
              </div>
              <div class="excess-area" id="fatExcess"></div>
            </div>

            <!-- Carbs -->
            <div class="flex flex-col items-center relative">
              <!-- Carb bucket sized for 25 blocks (25 * 12px = 300px) -->
              <div class="bucket h-[300px]" id="carbBucket">
                  <div class="target-line" style="top: 0%;"></div>
              </div>
              <div class="excess-area" id="carbExcess"></div>
            </div>
        </div>
    </div>
    
    <!-- Kitchen Panels (Center) -->
    <div class="flex-1 flex flex-col gap-4">
      <!-- Cabinets (Top) -->
      <div class="flex-1 wireframe-panel rounded-lg p-4 flex flex-col">
        <h2 class="text-xl font-bold text-gray-700 mb-4">Cabinets</h2>
        <div id="cabinets-content" class="flex-grow flex flex-wrap items-center justify-center p-2 overflow-hidden">
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="90" data-fat="40" data-carbs="490" data-src="https://img.icons8.com/color/96/bread.png">
              <img src="https://img.icons8.com/color/96/bread.png" alt="Bread" class="food w-16 h-16 rounded-md">
          </div>
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="250" data-fat="330" data-carbs="10" data-src="https://img.icons8.com/color/96/cheese.png">
              <img src="https://img.icons8.com/color/96/cheese.png" alt="Cheese" class="food w-16 h-16 rounded-md">
          </div>
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="130" data-fat="70" data-carbs="680" data-src="https://img.icons8.com/color/96/oat-flakes.png">
              <img src="https://img.icons8.com/color/96/oat-flakes.png" alt="Oats" class="food w-16 h-16 rounded-md">
          </div>
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="40" data-fat="0" data-carbs="280" data-src="https://img.icons8.com/color/96/rice-bowl.png">
              <img src="https://img.icons8.com/color/96/rice-bowl.png" alt="Rice" class="food w-16 h-16 rounded-md">
          </div>
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="0" data-fat="1000" data-carbs="0" data-src="https://img.icons8.com/color/96/olive-oil.png">
              <img src="https://img.icons8.com/color/96/olive-oil.png" alt="Olive Oil" class="food w-16 h-16 rounded-md">
          </div>
        </div>
      </div>
      <!-- Tabletop (Bottom) -->
      <div id="tabletop" class="flex-1 wireframe-panel rounded-lg p-4 flex flex-col dropzone relative" ondragover="event.preventDefault()" ondrop="handleDrop(event, this)">
        <h2 class="text-xl font-bold text-gray-700 mb-4">Tabletop</h2>
         <!-- Dropped items on the table will go here -->
      </div>
    </div>

    <!-- Right Panels -->
    <div class="flex flex-col w-1/5 gap-4">
      <!-- Fridge (Top) -->
      <div class="flex-1 wireframe-panel rounded-lg p-4 flex flex-col">
        <h2 class="text-xl font-bold text-gray-700 mb-4">Fridge</h2>
        <div id="fridge-content" class="flex-grow flex flex-wrap items-center justify-center p-2 overflow-hidden">
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="270" data-fat="190" data-carbs="0" data-src="https://img.icons8.com/color/96/steak.png">
              <img src="https://img.icons8.com/color/96/steak.png" alt="Steak" class="food w-16 h-16 rounded-md">
          </div>
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="30" data-fat="0" data-carbs="70" data-src="https://img.icons8.com/color/96/broccoli.png">
              <img src="https://img.icons8.com/color/96/broccoli.png" alt="Broccoli" class="food w-16 h-16 rounded-md">
          </div>
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="130" data-fat="110" data-carbs="10" data-src="https://img.icons8.com/color/96/eggs.png">
              <img src="https://img.icons8.com/color/96/eggs.png" alt="Eggs" class="food w-16 h-16 rounded-md">
          </div>
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="30" data-fat="40" data-carbs="50" data-src="https://img.icons8.com/color/96/milk-bottle.png">
              <img src="https://img.icons8.com/color/96/milk-bottle.png" alt="Milk" class="food w-16 h-16 rounded-md">
          </div>
          <div class="flex items-center m-2 draggable-food" draggable="true" data-protein="200" data-fat="130" data-carbs="0" data-src="https://img.icons8.com/color/96/salmon.png">
              <img src="https://img.icons8.com/color/96/salmon.png" alt="Salmon" class="food w-16 h-16 rounded-md">
          </div>
        </div>
      </div>
      <!-- Stack of Plates (Bottom) -->
      <div id="plate-stack-dropzone" class="flex-1 wireframe-panel rounded-lg p-4 flex flex-col dropzone relative" ondragover="event.preventDefault()" ondrop="handleDrop(event, this)">
        <h2 class="text-xl font-bold text-gray-700 mb-4">Stack of Plates</h2>
         <div class="dropped-items-on-plate absolute inset-0 flex flex-wrap items-center justify-center p-4 z-10"></div>
      </div>
    </div>
  </div>

  <script>
    let dragged;

    document.addEventListener("dragstart", e => {
      const target = e.target.closest('.draggable-food, .plate-draggable, .dropped-food');
      if (!target) return;
      if (target.classList.contains("draggable-food")) {
        if (target.closest("#cabinets-content") || target.closest("#fridge-content")) {
          dragged = target.cloneNode(true);
        } else {
          dragged = target.closest(".dropped-food");
        }
      } else if (target.classList.contains('plate-draggable')) {
        dragged = target.cloneNode(true);
      } else if (target.classList.contains('dropped-food')) {
        dragged = target;
      }
      document.querySelectorAll('.dropzone').forEach(dz => dz.classList.add('drag-over'));
    });

    document.addEventListener("dragend", e => {
      document.querySelectorAll('.dropzone').forEach(dz => dz.classList.remove('drag-over'));
    });

    function handleDrop(e, dropzone) {
      e.preventDefault();
      if (!dragged) return;
      const foodItem = dragged;
      if (dropzone.id === "tabletop") {
        if (foodItem.closest('#tabletop')) {
            dropzone.appendChild(foodItem);
        } else {
            addDroppedFoodItem(foodItem, dropzone);
        }
      }
      updateMacros();
    }

    function addDroppedFoodItem(foodItem, container) {
      let wrapper = document.createElement("div");
      wrapper.className = "dropped-food flex items-center justify-center m-4 z-40 relative";
      wrapper.draggable = true;
      const imgSource = foodItem.querySelector('img').src;
      const protein = foodItem.dataset.protein;
      const fat = foodItem.dataset.fat;
      const carbs = foodItem.dataset.carbs;
      
      let foodImg = document.createElement('img');
      foodImg.src = imgSource;
      foodImg.classList.add('food', 'w-20', 'h-20');
      foodImg.dataset.protein = protein;
      foodImg.dataset.fat = fat;
      foodImg.dataset.carbs = carbs;
      
      let sliderContainer = document.createElement("div");
      sliderContainer.className = "flex flex-col items-center ml-4";

      let portionLabel = document.createElement("span");
      portionLabel.className = "portion-label text-sm text-gray-700";
      
      let slider = document.createElement("input");
      slider.type="range";
      slider.min=10;
      slider.max=500;
      slider.value=100;
      slider.className="food-slider w-16 accent-lime-500 cursor-pointer";
      slider.addEventListener("input", ()=> updateMacros());

      let removeButton = document.createElement("button");
      removeButton.textContent = "Remove";
      removeButton.className = "mt-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full hover:bg-red-600 transition duration-200";
      removeButton.onclick = () => {
          wrapper.remove();
          updateMacros();
      };
      
      sliderContainer.appendChild(portionLabel);
      sliderContainer.appendChild(slider);
      sliderContainer.appendChild(removeButton);

      wrapper.appendChild(foodImg);
      wrapper.appendChild(sliderContainer);

      container.appendChild(wrapper);
      
      updateMacros();
    }

    function updateMacros() {
      let totalProtein=0, totalFat=0, totalCarbs=0;
      document.querySelectorAll(".dropped-food").forEach(df=>{
        let img=df.querySelector(".food");
        let slider=df.querySelector(".food-slider");
        if(img&&slider){
          let w=parseInt(slider.value);
          let portionLabel = df.querySelector(".portion-label");
          if(portionLabel) { portionLabel.textContent = `${w}g`; }
          totalProtein+=(parseFloat(img.dataset.protein)/100)*w;
          totalFat+=(parseFloat(img.dataset.fat)/100)*w;
          totalCarbs+=(parseFloat(img.dataset.carbs)/100)*w;
        }
      });
      renderBuckets(totalProtein,totalFat,totalCarbs);
    }

    function renderBuckets(p,f,c){
      // Pass the excess container ID to the renderBucket function
      renderBucket("proteinBucket", "proteinExcess", p, "protein-fill", 150);
      renderBucket("fatBucket", "fatExcess", f, "fat-fill", 70);
      renderBucket("carbBucket", "carbExcess", c, "carb-fill", 250);
    }

    function renderBucket(bucketId, excessId, value, colorClass, target){
      const bucket = document.getElementById(bucketId);
      const excess = document.getElementById(excessId);
      
      // Clear both containers
      bucket.querySelectorAll(".macro-block").forEach(el => el.remove());
      excess.querySelectorAll(".macro-block").forEach(el => el.remove());

      let blocks = Math.floor(value / 10);
      let maxBlocks = Math.floor(target / 10);

      for(let i = 0; i < blocks; i++){
        const block = document.createElement("div");
        block.className = `macro-block ${colorClass}`;
        
        if (i < maxBlocks) { 
          // Add to the main bucket
          bucket.appendChild(block);
        } else { 
          // Add to the excess area
          excess.appendChild(block);
        }
      }
    }
    
    function generatePlateStack() {
      const plateStackContainer = document.getElementById('plate-stack-dropzone');
      plateStackContainer.innerHTML = '';
      
      const numberOfPlates = 10;
      const verticalOffset = 10;
      const baseTop = 50;

      for (let i = 0; i < numberOfPlates; i++) {
        const plateDiv = document.createElement('div');
        plateDiv.className = 'plate-draggable plate';
        plateDiv.draggable = true;

        const plateImg = document.createElement('img');
        plateImg.src = 'https://img.icons8.com/color/96/plate.png';
        plateImg.alt = 'Plate';
        plateImg.className = 'w-full h-full object-contain';

        const top = baseTop + (i * verticalOffset * 0.5);
        
        plateDiv.style.top = `calc(50% - ${top}px)`;
        plateDiv.style.zIndex = i;

        plateDiv.appendChild(plateImg);
        plateStackContainer.appendChild(plateDiv);
      }
    }

    window.onload = () => { 
      generatePlateStack();
      updateMacros();
    }
  </script>
</body>
</html>
